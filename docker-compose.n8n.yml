version: '3.8'

services:
  # n8n - Plataforma de automatización de workflows para bot de WhatsApp/Telegram
  n8n:
    image: n8nio/n8n:latest
    container_name: recepcion-n8n
    environment:
      # ====================================
      # CONFIGURACIÓN BÁSICA
      # ====================================
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}

      # URL base para webhooks (importante para WhatsApp/Telegram)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}

      # ====================================
      # BASE DE DATOS
      # ====================================
      # SQLite por defecto (simple, para desarrollo/producción pequeña)
      # Para producción grande, considera PostgreSQL
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite

      # ====================================
      # ZONA HORARIA
      # ====================================
      - GENERIC_TIMEZONE=${TIMEZONE:-America/La_Paz}
      - TZ=${TIMEZONE:-America/La_Paz}

      # ====================================
      # SEGURIDAD
      # ====================================
      # Autenticación básica (cambiar en producción)
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-admin123}

      # ====================================
      # CONFIGURACIÓN DE EJECUCIÓN
      # ====================================
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_TIMEOUT=3600
      - EXECUTIONS_TIMEOUT_MAX=7200

      # Guardar historial de ejecuciones
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_MAX_AGE=336  # 14 días

      # ====================================
      # LOGGING
      # ====================================
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=console

      # ====================================
      # INTEGRACIÓN CON MICROSERVICIO
      # ====================================
      # URLs para que n8n se comunique con el microservicio
      - MICROSERVICIO_BASE_URL=${MICROSERVICIO_BASE_URL:-http://microservicio:8080}
      - MICROSERVICIO_API_KEY=${MICROSERVICIO_API_KEY:-dev-key-12345}

      # ====================================
      # CONFIGURACIÓN DE NODOS
      # ====================================
      - N8N_TEMPLATES_ENABLED=true
      - N8N_TEMPLATES_HOST=https://api.n8n.io

    ports:
      - "${N8N_PORT:-5678}:5678"

    volumes:
      # Persistencia de workflows, credenciales y base de datos
      - n8n_data:/home/node/.n8n

      # Backup de workflows (opcional, para versionamiento)
      - ./n8n/workflows:/backup:rw

    networks:
      - recepcion-network  # Red compartida con docker-compose.app.yml

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    labels:
      - "com.recepcion.service=n8n"
      - "com.recepcion.description=Bot de WhatsApp/Telegram para solicitud de ambulancias"
      - "com.recepcion.version=1.0.0"

# ====================================
# VOLÚMENES PERSISTENTES
# ====================================
volumes:
  n8n_data:
    driver: local
    name: recepcion_n8n_data

# ====================================
# RED COMPARTIDA CON STACK PRINCIPAL
# ====================================
# Esta red DEBE existir previamente (creada por docker-compose.app.yml)
networks:
  recepcion-network:
    external: true
    name: recepcion-network
