{
  "name": "Bot Telegram - Recepci√≥n Incidentes (CON ML)",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [250, 400],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Extraer datos del mensaje de Telegram\nconst message = $input.item.json.message;\nconst userId = String(message.from.id);\nconst userName = message.from.first_name || 'Usuario';\nconst username = message.from.username || String(message.chat.id);\nconst chatId = message.chat.id;\nconst text = message.text || '';\nconst hasLocation = !!message.location;\nconst hasPhoto = !!message.photo;\n\nreturn {\n  json: {\n    userId,\n    userName,\n    username,\n    chatId,\n    text,\n    hasLocation,\n    hasPhoto,\n    location: message.location,\n    photo: message.photo ? message.photo[message.photo.length - 1] : null,\n    originalMessage: message\n  }\n};"
      },
      "id": "extraer-datos",
      "name": "Extraer Datos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "functionCode": "// Obtener estado de la conversaci√≥n desde almacenamiento de n8n\nconst userId = $input.item.json.userId;\nconst storageKey = `conversacion_${userId}`;\nconst storage = $getWorkflowStaticData('global');\n\nconst estadoGuardado = storage[storageKey] || {\n  pasoActual: 'inicio',\n  datosRecolectados: {}\n};\n\nreturn {\n  json: {\n    ...estadoGuardado,\n    userId,\n    userName: $input.item.json.userName\n  }\n};"
      },
      "id": "obtener-estado",
      "name": "Obtener Estado",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "functionCode": "// Procesar mensaje seg√∫n el paso actual\nconst conversacion = $('Obtener Estado').first().json;\nconst mensajeData = $('Extraer Datos').first().json;\nconst text = mensajeData.text;\nconst paso = conversacion.pasoActual;\n\n// ===== COMANDOS ESPECIALES =====\nif (text === '/start') {\n  return {\n    json: {\n      action: 'send_message',\n      chatId: mensajeData.chatId,\n      message: `üö® *Bot de Recepci√≥n de Incidentes* üö®\\n\\n¬°Hola ${mensajeData.userName}!\\n\\n*Comandos:*\\n‚Ä¢ /reportar - Reportar incidente\\n‚Ä¢ /ayuda - Ver instrucciones\\n‚Ä¢ /cancelar - Cancelar reporte`,\n      parseMode: 'Markdown',\n      shouldUpdateConversacion: false\n    }\n  };\n}\n\nif (text === '/ayuda' || text === '/help') {\n  return {\n    json: {\n      action: 'send_message',\n      chatId: mensajeData.chatId,\n      message: `üìñ *C√≥mo reportar un incidente*\\n\\n*Comandos:*\\n/reportar - Iniciar reporte\\n/cancelar - Cancelar\\n\\n*Proceso:*\\n1Ô∏è‚É£ Nombre completo\\n2Ô∏è‚É£ Tel√©fono\\n3Ô∏è‚É£ Descripci√≥n del incidente\\n4Ô∏è‚É£ Ubicaci√≥n GPS\\n5Ô∏è‚É£ Fotos (opcional)\\n\\n‚úÖ Describe con claridad\\n‚úÖ Comparte ubicaci√≥n exacta`,\n      parseMode: 'Markdown',\n      shouldUpdateConversacion: false\n    }\n  };\n}\n\nif (text === '/cancelar') {\n  if (paso === 'inicio') {\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ÑπÔ∏è No hay reporte activo',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n  }\n  return {\n    json: {\n      action: 'cancelar',\n      chatId: mensajeData.chatId,\n      userId: mensajeData.userId,\n      message: '‚ùå *Reporte cancelado*\\n\\nUsa /reportar cuando necesites reportar un incidente',\n      parseMode: 'Markdown'\n    }\n  };\n}\n\nif (text === '/reportar') {\n  return {\n    json: {\n      action: 'update_conversation',\n      chatId: mensajeData.chatId,\n      userId: mensajeData.userId,\n      pasoActual: 'esperando_nombre',\n      datosRecolectados: {\n        username: mensajeData.username,\n        chatId: mensajeData.chatId\n      },\n      message: 'üö® *REPORTE DE INCIDENTE*\\n\\n1Ô∏è‚É£ Env√≠a tu *nombre completo*:',\n      parseMode: 'Markdown'\n    }\n  };\n}\n\n// ===== FLUJO SEG√öN PASO =====\nswitch (paso) {\n  case 'esperando_nombre':\n    if (!text || text.trim().length < 3) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ö†Ô∏è Nombre inv√°lido (m√≠nimo 3 caracteres)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_telefono',\n        datosRecolectados: { nombre: text.trim() },\n        message: `‚úÖ Nombre: *${text.trim()}*\\n\\n2Ô∏è‚É£ Env√≠a tu *n√∫mero de tel√©fono* (ej: +59175123456):`,\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_telefono':\n    if (!text || text.trim().length < 8) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ö†Ô∏è Tel√©fono inv√°lido (m√≠nimo 8 caracteres)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_descripcion',\n        datosRecolectados: { telefono: text.trim() },\n        message: `‚úÖ Tel√©fono registrado\\n\\n3Ô∏è‚É£ *Describe el incidente* con detalle:`,\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_descripcion':\n    if (!text || text.trim().length < 10) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ö†Ô∏è Describe con m√°s detalle (m√≠nimo 10 caracteres)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_ubicacion',\n        datosRecolectados: { descripcion: text.trim() },\n        message: '‚úÖ Descripci√≥n registrada\\n\\n4Ô∏è‚É£ *Comparte ubicaci√≥n GPS*\\n\\nüìé ‚Üí Ubicaci√≥n',\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_ubicacion':\n    if (!mensajeData.hasLocation) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ùå Usa üìé ‚Üí Ubicaci√≥n (debe ser GPS)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_fotos',\n        datosRecolectados: {\n          latitud: mensajeData.location.latitude,\n          longitud: mensajeData.location.longitude,\n          direccion: `GPS: ${mensajeData.location.latitude.toFixed(6)}, ${mensajeData.location.longitude.toFixed(6)}`\n        },\n        message: `‚úÖ Ubicaci√≥n recibida\\n\\n5Ô∏è‚É£ *Fotos* (opcional)\\n\\nEnv√≠a fotos o escribe *LISTO*`,\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_fotos':\n    if (mensajeData.hasPhoto) {\n      const fotos = conversacion.datosRecolectados.fotos || [];\n      fotos.push({\n        fileId: mensajeData.photo.file_id,\n        fileSize: mensajeData.photo.file_size\n      });\n      return {\n        json: {\n          action: 'update_conversation',\n          chatId: mensajeData.chatId,\n          userId: mensajeData.userId,\n          pasoActual: 'esperando_fotos',\n          datosRecolectados: { fotos },\n          message: `‚úÖ Foto ${fotos.length} recibida\\n\\n¬øM√°s fotos? Env√≠a o escribe *LISTO*`,\n          parseMode: 'Markdown'\n        }\n      };\n    }\n    if (text && (text.toUpperCase() === 'LISTO' || text.toUpperCase() === 'NO')) {\n      return {\n        json: {\n          action: 'create_incident',\n          chatId: mensajeData.chatId,\n          userId: mensajeData.userId,\n          conversacion: conversacion\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ö†Ô∏è Env√≠a foto o escribe *LISTO*',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n  \n  default:\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ùì Usa /reportar para reportar un incidente',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n}"
      },
      "id": "procesar-mensaje",
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "rule1",
              "leftValue": "={{ $json.action }}",
              "rightValue": "update_conversation",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule2",
              "leftValue": "={{ $json.action }}",
              "rightValue": "create_incident",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule3",
              "leftValue": "={{ $json.action }}",
              "rightValue": "cancelar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule4",
              "leftValue": "={{ $json.action }}",
              "rightValue": "send_message",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "switch-action",
      "name": "¬øQu√© Acci√≥n?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "functionCode": "// Guardar estado en almacenamiento de n8n\nconst data = $input.item.json;\nconst userId = data.userId;\nconst storageKey = `conversacion_${userId}`;\nconst storage = $getWorkflowStaticData('global');\n\n// Obtener estado anterior\nconst estadoAnterior = storage[storageKey] || { datosRecolectados: {} };\n\n// Combinar datos anteriores con nuevos datos\nconst datosRecolectadosCombinados = {\n  ...estadoAnterior.datosRecolectados,\n  ...data.datosRecolectados\n};\n\n// Guardar estado actualizado\nstorage[storageKey] = {\n  pasoActual: data.pasoActual,\n  datosRecolectados: datosRecolectadosCombinados\n};\n\nreturn {\n  json: {\n    ...data,\n    datosRecolectados: datosRecolectadosCombinados\n  }\n};"
      },
      "id": "guardar-estado",
      "name": "Guardar Estado",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "enviar-respuesta",
      "name": "Enviar Respuesta",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 200],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://microservicio:8080/api/incidentes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"solicitante\": {\n    \"nombreCompleto\": \"{{ $json.conversacion.datosRecolectados.nombre }}\",\n    \"telefono\": \"{{ $json.conversacion.datosRecolectados.telefono }}\",\n    \"canalOrigen\": \"TELEGRAM\"\n  },\n  \"ubicacion\": {\n    \"descripcionTextual\": \"{{ $json.conversacion.datosRecolectados.direccion }}\",\n    \"latitud\": {{ $json.conversacion.datosRecolectados.latitud }},\n    \"longitud\": {{ $json.conversacion.datosRecolectados.longitud }}\n  },\n  \"descripcionOriginal\": \"{{ $json.conversacion.datosRecolectados.descripcion }}\",\n  \"tipoIncidenteReportado\": \"INCIDENTE_GENERAL\"\n}",
        "options": {}
      },
      "id": "crear-incidente",
      "name": "POST /incidentes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Mensaje').first().json.chatId }}",
        "text": "=‚è≥ *Incidente registrado*\\n\\nüÜî ID: `{{ $json.id }}`\\nüìä Estado: {{ $json.estado }}\\n\\nü§ñ *Analizando con IA...*\\nüìù An√°lisis de texto\\nüì∏ An√°lisis de im√°genes\\n‚ö° Calculando prioridad\\n\\n_Espera un momento por favor_",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "notificar-analisis",
      "name": "Notificar An√°lisis en Progreso",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 400],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "id": "wait-ml",
      "name": "Esperar ML (10seg)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1650, 400],
      "webhookId": "wait-ml-webhook"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://microservicio:8080/api/incidentes/{{ $('POST /incidentes').first().json.id }}/detalle",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            }
          ]
        },
        "options": {}
      },
      "id": "consultar-incidente",
      "name": "GET /incidentes/{id}/detalle",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.prioridad }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-ml-ready",
      "name": "¬øML Listo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "wait-retry",
      "name": "Esperar 5seg m√°s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1850, 600],
      "webhookId": "wait-retry-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Evaluar prioridad y crear mensaje apropiado\nconst incidente = $input.item.json;\nconst prioridad = incidente.prioridad;\nconst chatId = $('Procesar Mensaje').first().json.chatId;\nconst userId = $('Procesar Mensaje').first().json.userId;\n\n// Datos del an√°lisis\nconst analisisTexto = incidente.analisisTexto || {};\nconst analisisImagen = incidente.analisisImagen || {};\n\nlet emoji, titulo, mensaje, urgencia;\n\n// Determinar nivel de urgencia seg√∫n prioridad\nif (prioridad >= 8) {\n  emoji = 'üö®';\n  titulo = 'PRIORIDAD CR√çTICA';\n  urgencia = 'CR√çTICA';\n  mensaje = '‚ö†Ô∏è *ATENCI√ìN INMEDIATA REQUERIDA*\\n\\nüöë El incidente requiere atenci√≥n urgente\\n‚è±Ô∏è Ser√° procesado con m√°xima prioridad\\n\\nüìû Nos contactaremos contigo pronto';\n} else if (prioridad >= 6) {\n  emoji = 'üî¥';\n  titulo = 'PRIORIDAD ALTA';\n  urgencia = 'ALTA';\n  mensaje = '‚ö° *ATENCI√ìN PRIORITARIA*\\n\\nüìã El incidente ser√° atendido con alta prioridad\\n‚è±Ô∏è Procesamiento acelerado\\n\\nüìû Recibir√°s una respuesta pronto';\n} else if (prioridad >= 4) {\n  emoji = 'üü°';\n  titulo = 'PRIORIDAD MEDIA';\n  urgencia = 'MEDIA';\n  mensaje = 'üìä *EN REVISI√ìN*\\n\\n‚úÖ Incidente registrado correctamente\\n‚è±Ô∏è Ser√° procesado en el orden de llegada\\n\\nüìû Te contactaremos cuando sea necesario';\n} else {\n  emoji = 'üîµ';\n  titulo = 'PRIORIDAD BAJA';\n  urgencia = 'BAJA';\n  mensaje = 'üìù *REGISTRADO*\\n\\n‚úÖ Tu reporte ha sido registrado\\n‚è±Ô∏è Ser√° evaluado y procesado\\n\\nüí° Te contactaremos si necesitamos m√°s informaci√≥n';\n}\n\n// Construir mensaje detallado\nlet mensajeFinal = `${emoji} *${titulo}* ${emoji}\\n\\n`;\nmensajeFinal += `üÜî ID: \\`${incidente.id}\\`\\n`;\nmensajeFinal += `‚ö° Prioridad: *${prioridad}/10*\\n`;\nmensajeFinal += `üìä Urgencia: *${urgencia}*\\n`;\nmensajeFinal += `üìÖ Estado: ${incidente.estado}\\n\\n`;\n\n// Agregar an√°lisis de texto si est√° disponible\nif (analisisTexto.tipoIncidente) {\n  mensajeFinal += `üìù *An√°lisis de Texto:*\\n`;\n  mensajeFinal += `‚Ä¢ Tipo: ${analisisTexto.tipoIncidente}\\n`;\n  if (analisisTexto.urgencia) {\n    mensajeFinal += `‚Ä¢ Urgencia detectada: ${analisisTexto.urgencia}/10\\n`;\n  }\n  if (analisisTexto.sentimiento) {\n    mensajeFinal += `‚Ä¢ Sentimiento: ${analisisTexto.sentimiento}\\n`;\n  }\n  mensajeFinal += `\\n`;\n}\n\n// Agregar an√°lisis de imagen si est√° disponible\nif (analisisImagen.severidad) {\n  mensajeFinal += `üì∏ *An√°lisis de Imagen:*\\n`;\n  mensajeFinal += `‚Ä¢ Severidad: ${analisisImagen.severidad}/10\\n`;\n  if (analisisImagen.confianza) {\n    mensajeFinal += `‚Ä¢ Confianza: ${(analisisImagen.confianza * 100).toFixed(0)}%\\n`;\n  }\n  mensajeFinal += `\\n`;\n}\n\nmensajeFinal += mensaje;\nmensajeFinal += `\\n\\n_Gracias por usar nuestro servicio_`;\n\nreturn {\n  json: {\n    chatId,\n    message: mensajeFinal,\n    prioridad,\n    incidenteId: incidente.id,\n    userId\n  }\n};"
      },
      "id": "evaluar-prioridad",
      "name": "Evaluar Prioridad y Crear Mensaje",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "notificar-resultado",
      "name": "Notificar Resultado ML",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [2450, 300],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Limpiar estado de conversaci√≥n\nconst userId = $input.item.json.userId;\nconst storageKey = `conversacion_${userId}`;\nconst storage = $getWorkflowStaticData('global');\n\n// Eliminar estado\ndelete storage[storageKey];\n\nreturn {\n  json: {\n    ....$input.item.json,\n    conversacionLimpiada: true\n  }\n};"
      },
      "id": "limpiar-estado",
      "name": "Limpiar Estado",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Cancelar conversaci√≥n - limpiar estado\nconst userId = $input.item.json.userId;\nconst storageKey = `conversacion_${userId}`;\nconst storage = $getWorkflowStaticData('global');\n\n// Eliminar estado\ndelete storage[storageKey];\n\nreturn {\n  json: {\n    chatId: $input.item.json.chatId,\n    message: $input.item.json.message,\n    parseMode: $input.item.json.parseMode\n  }\n};"
      },
      "id": "cancelar-conversacion",
      "name": "Cancelar Conversaci√≥n",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 600]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "={{ $json.parseMode || 'Markdown' }}"
        }
      },
      "id": "enviar-cancelacion",
      "name": "Enviar Cancelaci√≥n",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 600],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "={{ $json.parseMode || 'Markdown' }}"
        }
      },
      "id": "enviar-mensaje-simple",
      "name": "Enviar Mensaje Simple",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1250, 800],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [[{ "node": "Extraer Datos", "type": "main", "index": 0 }]]
    },
    "Extraer Datos": {
      "main": [[{ "node": "Obtener Estado", "type": "main", "index": 0 }]]
    },
    "Obtener Estado": {
      "main": [[{ "node": "Procesar Mensaje", "type": "main", "index": 0 }]]
    },
    "Procesar Mensaje": {
      "main": [[{ "node": "¬øQu√© Acci√≥n?", "type": "main", "index": 0 }]]
    },
    "¬øQu√© Acci√≥n?": {
      "main": [
        [{ "node": "Guardar Estado", "type": "main", "index": 0 }],
        [{ "node": "POST /incidentes", "type": "main", "index": 0 }],
        [{ "node": "Cancelar Conversaci√≥n", "type": "main", "index": 0 }],
        [{ "node": "Enviar Mensaje Simple", "type": "main", "index": 0 }]
      ]
    },
    "Guardar Estado": {
      "main": [[{ "node": "Enviar Respuesta", "type": "main", "index": 0 }]]
    },
    "POST /incidentes": {
      "main": [[{ "node": "Notificar An√°lisis en Progreso", "type": "main", "index": 0 }]]
    },
    "Notificar An√°lisis en Progreso": {
      "main": [[{ "node": "Esperar ML (10seg)", "type": "main", "index": 0 }]]
    },
    "Esperar ML (10seg)": {
      "main": [[{ "node": "GET /incidentes/{id}/detalle", "type": "main", "index": 0 }]]
    },
    "GET /incidentes/{id}/detalle": {
      "main": [[{ "node": "¬øML Listo?", "type": "main", "index": 0 }]]
    },
    "¬øML Listo?": {
      "main": [
        [{ "node": "Evaluar Prioridad y Crear Mensaje", "type": "main", "index": 0 }],
        [{ "node": "Esperar 5seg m√°s", "type": "main", "index": 0 }]
      ]
    },
    "Esperar 5seg m√°s": {
      "main": [[{ "node": "GET /incidentes/{id}/detalle", "type": "main", "index": 0 }]]
    },
    "Evaluar Prioridad y Crear Mensaje": {
      "main": [[{ "node": "Notificar Resultado ML", "type": "main", "index": 0 }]]
    },
    "Notificar Resultado ML": {
      "main": [[{ "node": "Limpiar Estado", "type": "main", "index": 0 }]]
    },
    "Cancelar Conversaci√≥n": {
      "main": [[{ "node": "Enviar Cancelaci√≥n", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "corregido-1.0.0",
  "id": "bot-telegram-incidentes-corregido",
  "meta": {
    "instanceId": "recepcion-n8n"
  },
  "tags": []
}
