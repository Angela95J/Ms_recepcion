{
  "name": "Bot Telegram - Ambulancias FINAL (con notificaci√≥n ML)",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger-001",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [250, 400],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Extraer informaci√≥n del mensaje de Telegram\nconst message = $input.item.json.message;\nconst userId = String(message.from.id);\nconst userName = message.from.first_name || 'Usuario';\nconst username = message.from.username || String(message.chat.id);\nconst chatId = message.chat.id;\nconst text = message.text || '';\nconst hasLocation = !!message.location;\nconst hasPhoto = !!message.photo;\n\nreturn {\n  json: {\n    userId,\n    userName,\n    username,\n    chatId,\n    text,\n    hasLocation,\n    hasPhoto,\n    location: message.location,\n    photo: message.photo ? message.photo[message.photo.length - 1] : null,\n    originalMessage: message\n  }\n};"
      },
      "id": "extract-data-001",
      "name": "Extraer Datos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://microservicio:8080/api/conversaciones/iniciar",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"userId\": \"{{ $json.userId }}\",\n  \"userName\": \"{{ $json.userName }}\",\n  \"canalOrigen\": \"TELEGRAM\"\n}",
        "options": {}
      },
      "id": "get-conversation-001",
      "name": "Obtener Conversaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "functionCode": "// Procesar mensaje seg√∫n el paso actual\nconst conversacion = $input.item.json;\nconst mensajeData = $('Extraer Datos').first().json;\nconst text = mensajeData.text;\nconst paso = conversacion.pasoActual;\n\n// ===== COMANDOS ESPECIALES =====\nif (text === '/start') {\n  return {\n    json: {\n      action: 'send_message',\n      chatId: mensajeData.chatId,\n      message: `üöë *Bot de Ambulancias* üöë\\n\\n¬°Hola ${mensajeData.userName}!\\n\\n*Comandos:*\\n‚Ä¢ /solicitar - Solicitar ambulancia\\n‚Ä¢ /ayuda - Ver instrucciones\\n‚Ä¢ /cancelar - Cancelar solicitud`,\n      parseMode: 'Markdown',\n      shouldUpdateConversacion: false\n    }\n  };\n}\n\nif (text === '/ayuda' || text === '/help') {\n  return {\n    json: {\n      action: 'send_message',\n      chatId: mensajeData.chatId,\n      message: `üìñ *C√≥mo usar el bot*\\n\\n*Comandos:*\\n/solicitar - Iniciar\\n/cancelar - Cancelar\\n\\n*Proceso:*\\n1Ô∏è‚É£ Nombre\\n2Ô∏è‚É£ Descripci√≥n\\n3Ô∏è‚É£ GPS (üìé‚ÜíUbicaci√≥n)\\n4Ô∏è‚É£ Fotos (opcional)\\n\\n‚úÖ Describe con claridad\\n‚úÖ Comparte ubicaci√≥n exacta`,\n      parseMode: 'Markdown',\n      shouldUpdateConversacion: false\n    }\n  };\n}\n\nif (text === '/cancelar') {\n  if (paso === 'inicio') {\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ÑπÔ∏è No hay solicitud activa',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n  }\n  return {\n    json: {\n      action: 'cancelar',\n      chatId: mensajeData.chatId,\n      userId: mensajeData.userId\n    }\n  };\n}\n\nif (text === '/solicitar') {\n  return {\n    json: {\n      action: 'update_conversation',\n      chatId: mensajeData.chatId,\n      userId: mensajeData.userId,\n      pasoActual: 'esperando_nombre',\n      datosRecolectados: {\n        username: mensajeData.username,\n        chatId: mensajeData.chatId\n      },\n      message: 'üö® *SOLICITUD DE AMBULANCIA*\\n\\n1Ô∏è‚É£ Env√≠a tu *nombre completo*:',\n      parseMode: 'Markdown'\n    }\n  };\n}\n\n// ===== FLUJO SEG√öN PASO =====\nswitch (paso) {\n  case 'esperando_nombre':\n    if (!text || text.trim().length < 3) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ö†Ô∏è Nombre inv√°lido (m√≠nimo 3 caracteres)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_descripcion',\n        datosRecolectados: { nombre: text.trim() },\n        message: `‚úÖ Nombre: *${text.trim()}*\\n\\n2Ô∏è‚É£ *Describe la emergencia*:`,\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_descripcion':\n    if (!text || text.trim().length < 10) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ö†Ô∏è Describe con m√°s detalle (m√≠nimo 10 caracteres)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_ubicacion',\n        datosRecolectados: { descripcion: text.trim() },\n        message: '‚úÖ Descripci√≥n registrada\\n\\n3Ô∏è‚É£ *Comparte ubicaci√≥n GPS*\\n\\nüìé ‚Üí Ubicaci√≥n',\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_ubicacion':\n    if (!mensajeData.hasLocation) {\n      return {\n        json: {\n          action: 'send_message',\n          chatId: mensajeData.chatId,\n          message: '‚ùå Usa üìé ‚Üí Ubicaci√≥n (debe ser GPS)',\n          parseMode: 'Markdown',\n          shouldUpdateConversacion: false\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'update_conversation',\n        chatId: mensajeData.chatId,\n        userId: mensajeData.userId,\n        pasoActual: 'esperando_fotos',\n        datosRecolectados: {\n          latitud: mensajeData.location.latitude,\n          longitud: mensajeData.location.longitude,\n          direccion: `Lat: ${mensajeData.location.latitude.toFixed(6)}, Lon: ${mensajeData.location.longitude.toFixed(6)}`\n        },\n        message: `‚úÖ Ubicaci√≥n recibida\\n\\n4Ô∏è‚É£ *Fotos* (opcional)\\n\\nEnv√≠a fotos o escribe *LISTO*`,\n        parseMode: 'Markdown'\n      }\n    };\n  \n  case 'esperando_fotos':\n    if (mensajeData.hasPhoto) {\n      const fotos = conversacion.datosRecolectados.fotos || [];\n      fotos.push({\n        fileId: mensajeData.photo.file_id,\n        fileSize: mensajeData.photo.file_size\n      });\n      return {\n        json: {\n          action: 'update_conversation',\n          chatId: mensajeData.chatId,\n          userId: mensajeData.userId,\n          pasoActual: 'esperando_fotos',\n          datosRecolectados: { fotos },\n          message: `‚úÖ Foto ${fotos.length} recibida\\n\\n¬øM√°s fotos? Env√≠a o escribe *LISTO*`,\n          parseMode: 'Markdown'\n        }\n      };\n    }\n    if (text && (text.toUpperCase() === 'LISTO' || text.toUpperCase() === 'NO')) {\n      return {\n        json: {\n          action: 'create_incident',\n          chatId: mensajeData.chatId,\n          userId: mensajeData.userId,\n          conversacion: conversacion\n        }\n      };\n    }\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ö†Ô∏è Env√≠a foto o escribe *LISTO*',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n  \n  default:\n    return {\n      json: {\n        action: 'send_message',\n        chatId: mensajeData.chatId,\n        message: '‚ùì Usa /solicitar para pedir ambulancia',\n        parseMode: 'Markdown',\n        shouldUpdateConversacion: false\n      }\n    };\n}"
      },
      "id": "process-message-001",
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "rule1",
              "leftValue": "={{ $json.action }}",
              "rightValue": "update_conversation",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule2",
              "leftValue": "={{ $json.action }}",
              "rightValue": "create_incident",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule3",
              "leftValue": "={{ $json.action }}",
              "rightValue": "cancelar",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "rule4",
              "leftValue": "={{ $json.action }}",
              "rightValue": "send_message",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "switch-action-001",
      "name": "¬øQu√© Acci√≥n?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=http://microservicio:8080/api/conversaciones/{{ $json.userId }}?canal=TELEGRAM",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"pasoActual\": \"{{ $json.pasoActual }}\",\n  \"datosRecolectados\": {{ JSON.stringify($json.datosRecolectados) }}\n}",
        "options": {}
      },
      "id": "update-conv-001",
      "name": "Actualizar Conversaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Mensaje').first().json.chatId }}",
        "text": "={{ $('Procesar Mensaje').first().json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-update-msg-001",
      "name": "Enviar Respuesta",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 200],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://microservicio:8080/api/incidentes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"solicitante\": {\n    \"nombreCompleto\": \"{{ $json.conversacion.datosRecolectados.nombre }}\",\n    \"telefono\": \"{{ $json.conversacion.datosRecolectados.username }}\",\n    \"canalOrigen\": \"TELEGRAM\"\n  },\n  \"ubicacion\": {\n    \"descripcionTextual\": \"{{ $json.conversacion.datosRecolectados.direccion }}\",\n    \"latitud\": {{ $json.conversacion.datosRecolectados.latitud }},\n    \"longitud\": {{ $json.conversacion.datosRecolectados.longitud }}\n  },\n  \"descripcionOriginal\": \"{{ $json.conversacion.datosRecolectados.descripcion }}\",\n  \"tipoIncidenteReportado\": \"EMERGENCIA_MEDICA\"\n}",
        "options": {}
      },
      "id": "create-incident-001",
      "name": "Crear Incidente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Mensaje').first().json.chatId }}",
        "text": "=‚è≥ *Solicitud registrada*\\n\\nüìã C√≥digo: `{{ $json.codigo }}`\\nüÜî ID: `{{ $json.id }}`\\n\\nü§ñ *Analizando con IA...*\\n‚öïÔ∏è Evaluando gravedad\\nüìä Procesando datos\\n\\n_Espera un momento por favor_",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-waiting-msg-001",
      "name": "Notificar An√°lisis en Progreso",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 400],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "id": "wait-ml-001",
      "name": "Esperar ML (10seg)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1650, 400],
      "webhookId": "wait-ml-webhook"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://microservicio:8080/api/incidentes/{{ $('Crear Incidente').first().json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            }
          ]
        },
        "options": {}
      },
      "id": "check-incident-001",
      "name": "Consultar Incidente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.prioridadFinal }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-ml-ready-001",
      "name": "¬øML Listo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "wait-retry-001",
      "name": "Esperar 5seg m√°s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1850, 600],
      "webhookId": "wait-retry-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Evaluar prioridad y crear mensaje apropiado\nconst incidente = $input.item.json;\nconst prioridad = incidente.prioridadFinal;\nconst codigo = incidente.codigo;\nconst chatId = $('Procesar Mensaje').first().json.chatId;\n\nlet emoji, titulo, mensaje, urgencia;\n\nswitch(prioridad) {\n  case 'CRITICA':\n    emoji = 'üö®';\n    titulo = 'EMERGENCIA CR√çTICA';\n    mensaje = 'Ambulancia despachada *INMEDIATAMENTE*\\n\\n‚è±Ô∏è Tiempo estimado: 5-10 minutos\\nüöë Unidad de emergencia en camino\\n\\n‚ö†Ô∏è *MANTENTE EN LA UBICACI√ìN*\\nüìû Te llamaremos si necesitamos m√°s informaci√≥n';\n    urgencia = 'M√ÅXIMA';\n    break;\n    \n  case 'ALTA':\n    emoji = 'üö®';\n    titulo = 'EMERGENCIA ALTA';\n    mensaje = 'Ambulancia despachada *DE INMEDIATO*\\n\\n‚è±Ô∏è Tiempo estimado: 10-20 minutos\\nüöë Prioridad alta confirmada\\n\\n‚úÖ Mantente en la ubicaci√≥n\\nüìû Mant√©n tu tel√©fono disponible';\n    urgencia = 'ALTA';\n    break;\n    \n  case 'MEDIA':\n    emoji = 'üü°';\n    titulo = 'EMERGENCIA MODERADA';\n    mensaje = 'Ambulancia en camino\\n\\n‚è±Ô∏è Tiempo estimado: 20-40 minutos\\nüöë Unidad asignada\\n\\n‚úÖ Mantente tranquilo\\nüìû Te contactaremos pronto';\n    urgencia = 'MEDIA';\n    break;\n    \n  case 'BAJA':\n  default:\n    emoji = 'üîµ';\n    titulo = 'SOLICITUD REGISTRADA';\n    mensaje = 'Evaluando disponibilidad de unidades\\n\\n‚è±Ô∏è Tiempo estimado: 40-60 minutos\\nüìã Solicitud en cola\\n\\nüí° Si la situaci√≥n empeora, llama al 911\\nüìû Te contactaremos para confirmar';\n    urgencia = 'BAJA';\n    break;\n}\n\nconst mensajeFinal = `${emoji} *${titulo}* ${emoji}\\n\\nüìã C√≥digo: \\`${codigo}\\`\\n‚ö° Urgencia: *${urgencia}*\\n\\n${mensaje}\\n\\n_Gracias por usar nuestro servicio_`;\n\nreturn {\n  json: {\n    chatId,\n    message: mensajeFinal,\n    prioridad,\n    incidenteId: incidente.id,\n    userId: $('Procesar Mensaje').first().json.userId\n  }\n};"
      },
      "id": "evaluate-priority-001",
      "name": "Evaluar Prioridad",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-final-result-001",
      "name": "Notificar Resultado ML",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [2450, 300],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://microservicio:8080/api/conversaciones/{{ $json.userId }}/finalizar?canal=TELEGRAM&incidenteId={{ $json.incidenteId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            }
          ]
        },
        "options": {}
      },
      "id": "finalize-conv-001",
      "name": "Finalizar Conversaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2650, 300]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=http://microservicio:8080/api/conversaciones/{{ $json.userId }}?canal=TELEGRAM",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "dev-key-12345"
            }
          ]
        },
        "options": {}
      },
      "id": "cancel-conv-001",
      "name": "Cancelar Conversaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 600]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "‚ùå *Solicitud cancelada*\\n\\nUsa /solicitar cuando necesites ambulancia",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-cancel-msg-001",
      "name": "Confirmar Cancelaci√≥n",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1450, 600],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "={{ $json.parseMode || 'Markdown' }}"
        }
      },
      "id": "send-simple-msg-001",
      "name": "Enviar Mensaje Simple",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1250, 800],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [[{ "node": "Extraer Datos", "type": "main", "index": 0 }]]
    },
    "Extraer Datos": {
      "main": [[{ "node": "Obtener Conversaci√≥n", "type": "main", "index": 0 }]]
    },
    "Obtener Conversaci√≥n": {
      "main": [[{ "node": "Procesar Mensaje", "type": "main", "index": 0 }]]
    },
    "Procesar Mensaje": {
      "main": [[{ "node": "¬øQu√© Acci√≥n?", "type": "main", "index": 0 }]]
    },
    "¬øQu√© Acci√≥n?": {
      "main": [
        [{ "node": "Actualizar Conversaci√≥n", "type": "main", "index": 0 }],
        [{ "node": "Crear Incidente", "type": "main", "index": 0 }],
        [{ "node": "Cancelar Conversaci√≥n", "type": "main", "index": 0 }],
        [{ "node": "Enviar Mensaje Simple", "type": "main", "index": 0 }]
      ]
    },
    "Actualizar Conversaci√≥n": {
      "main": [[{ "node": "Enviar Respuesta", "type": "main", "index": 0 }]]
    },
    "Crear Incidente": {
      "main": [[{ "node": "Notificar An√°lisis en Progreso", "type": "main", "index": 0 }]]
    },
    "Notificar An√°lisis en Progreso": {
      "main": [[{ "node": "Esperar ML (10seg)", "type": "main", "index": 0 }]]
    },
    "Esperar ML (10seg)": {
      "main": [[{ "node": "Consultar Incidente", "type": "main", "index": 0 }]]
    },
    "Consultar Incidente": {
      "main": [[{ "node": "¬øML Listo?", "type": "main", "index": 0 }]]
    },
    "¬øML Listo?": {
      "main": [
        [{ "node": "Evaluar Prioridad", "type": "main", "index": 0 }],
        [{ "node": "Esperar 5seg m√°s", "type": "main", "index": 0 }]
      ]
    },
    "Esperar 5seg m√°s": {
      "main": [[{ "node": "Consultar Incidente", "type": "main", "index": 0 }]]
    },
    "Evaluar Prioridad": {
      "main": [[{ "node": "Notificar Resultado ML", "type": "main", "index": 0 }]]
    },
    "Notificar Resultado ML": {
      "main": [[{ "node": "Finalizar Conversaci√≥n", "type": "main", "index": 0 }]]
    },
    "Cancelar Conversaci√≥n": {
      "main": [[{ "node": "Confirmar Cancelaci√≥n", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "final-1.0.0",
  "id": "bot-telegram-ambulancias-final",
  "meta": {
    "instanceId": "recepcion-n8n"
  },
  "tags": []
}
