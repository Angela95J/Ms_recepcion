version: '3.8'

# ====================================
# DOCKER COMPOSE PARA PRODUCCIÓN
# DigitalOcean Droplet
# ====================================

services:
  # -------------------------
  # Base de datos PostgreSQL
  # -------------------------
  postgres:
    image: postgres:15-alpine
    container_name: recepcion-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-MSrecepcion}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "127.0.0.1:5432:5432"  # Solo accesible localmente
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - recepcion-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-MSrecepcion}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # ML - Análisis de Texto
  # -------------------------
  ml-texto:
    build:
      context: ./ml_analisis_texto
      dockerfile: Dockerfile
    container_name: recepcion-ml-texto
    environment:
      PORT: 8001
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    expose:
      - "8001"
    volumes:
      - ./ml_analisis_texto/trained_models:/app/trained_models:ro
      - ./ml_analisis_texto/data:/app/data
    networks:
      - recepcion-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # ML - Análisis de Imagen
  # -------------------------
  ml-imagen:
    build:
      context: ./ml_analisis_imagen
      dockerfile: Dockerfile
    container_name: recepcion-ml-imagen
    environment:
      PORT: 8002
      MODEL_PATH: /app/trained_models
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    expose:
      - "8002"
    volumes:
      - ./ml_analisis_imagen/trained_models:/app/trained_models:ro
      - ./ml_analisis_imagen/data:/app/data
    networks:
      - recepcion-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # Microservicio Spring Boot
  # -------------------------
  microservicio:
    build:
      context: ./recepcion
      dockerfile: Dockerfile
    container_name: recepcion-microservicio
    environment:
      # Base de datos
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-MSrecepcion}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      # Servicios ML
      ML_TEXTO_BASE_URL: http://ml-texto:8001
      ML_IMAGEN_BASE_URL: http://ml-imagen:8002
      ML_TEXTO_ENABLED: true
      ML_IMAGEN_ENABLED: true

      # Configuración de la aplicación
      SPRING_PROFILES_ACTIVE: prod
      APP_MULTIMEDIA_UPLOAD_DIR: /app/uploads
      APP_MULTIMEDIA_MAX_FILE_SIZE: 10485760
      APP_MULTIMEDIA_BASE_URL: ${APP_URL:-https://tu-dominio.com}/api

      # Seguridad (API Keys)
      API_KEY_ADMIN: ${API_KEY_ADMIN}
      API_KEY_N8N: ${API_KEY_N8N}

      # JVM Options
      JAVA_OPTS: ${JAVA_OPTS:--Xms512m -Xmx1024m}
    expose:
      - "8080"
    volumes:
      - uploads_data:/app/uploads
    networks:
      - recepcion-network
    depends_on:
      postgres:
        condition: service_healthy
      ml-texto:
        condition: service_started
      ml-imagen:
        condition: service_started
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # n8n - Automatización
  # -------------------------
  n8n:
    image: n8nio/n8n:latest
    container_name: recepcion-n8n
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_HOST=${N8N_HOST:-tu-dominio.com}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://tu-dominio.com}

      # Base de datos SQLite
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite

      # Configuración de ejecución
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_TIMEOUT=3600
      - EXECUTIONS_TIMEOUT_MAX=7200
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_MAX_AGE=336

      # Timezone
      - GENERIC_TIMEZONE=${TZ:-America/Mexico_City}
      - TZ=${TZ:-America/Mexico_City}

      # Templates
      - N8N_TEMPLATES_ENABLED=true
      - N8N_TEMPLATES_HOST=https://api.n8n.io

      # Integración con microservicio
      - MICROSERVICIO_API_URL=http://microservicio:8080/api
      - MICROSERVICIO_API_KEY=${API_KEY_N8N}
    expose:
      - "5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/workflows:/backup:rw
    networks:
      - recepcion-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # Nginx - Reverse Proxy
  # -------------------------
  nginx:
    image: nginx:alpine
    container_name: recepcion-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    networks:
      - recepcion-network
    depends_on:
      - microservicio
      - n8n
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -------------------------
  # Certbot - SSL/HTTPS
  # -------------------------
  certbot:
    image: certbot/certbot
    container_name: recepcion-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    restart: always

# ====================================
# VOLÚMENES PERSISTENTES
# ====================================
volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local
  n8n_data:
    driver: local

# ====================================
# RED INTERNA
# ====================================
networks:
  recepcion-network:
    driver: bridge
